Blog?

- choice of FR4, dielectric loss, suitability for high speed PCIe 3.0 and above
    - PCIe protocol
    - frequency requirements
    - intel spec for PCIe 3.0

- design to improve EMI performance
    - using ground layers as shielding
    - via size, enig and manufacturing cost

- single board design vs flex pcb design
    - engineering cost of board larger than 10x10
    - engineering cost of 0.8mm board
    - cost of flex pcb
    - flexibility of design with flexpcb
        - 0.8mm and sub 5x5 design 4 layer means cheap m.2 card
        - flex pcb is sub 10x10 so cheap and 2 layer
        - 1.6mm and sub 10x10 design 4 layer means cheaper oculink port board
    - manufacturing issues when moving to flex pcb
        - need good soldering with flex pcb to boards
        - required applying a heavy weight to connector when reflow soldering
        - two extra soldered connections compared to single board design
        - oculink port extremely difficult to solder without internal bridging
        - manual testing for shorts and bad connections time consuming for flex pcb connections and oculink port
        - single reflow step for single board design much easier to test
        - lots of solder balls created from solder paste (flux boiled and ejected solder balls)
            - possibly due to aggressive reflow profile???
            - reflow profile sped up due to needed to repeat process multiple times to correct for bad connections or shorts
        - flexpcb connector is soldered but width of SMD pads are different between ground and signal lines
            - when using a naiive soldering technique by tinning the connectors there was a height difference due to surface tension
            - resulted in no or bad connections for signal lines
            - when compressing connector during reflow, the extra solder on ground pads spilled out and resulted in shorts
            - needed to guarantee that tinned pads for ground and signal pads has solder at the same height
            - required manually levelling the solder by removing as much solder after tinning process
            - this resulted in tinning with leaded solder on both flex pcb and board side pads which meant reflow with weight to compress connection would result in a good connection without shorts
        - positioning of flexpcb was extremely time consuming
            - required preheating board on reflow plate at 140 degrees celcius
            - then under a magnifying glass with tweezers, reposition the connector to the correct location
            - tolerance is very low for good connection (sub 0.05mm)
            - then required touchup of ground pads to reflow solder and keep connector in place for reflow attempt
        - flexpcb connection was then compressed with a weight (5kg dumbbell) and reflowed at 220 celcius for 1 minute
        - manual checks with multimeter for shorts or open connections to verify soldering job was correct
        - required multiple approaches and attempts until repeatable reliable procedure was developed
        - used naiive reflow attempts to very disappointing and unreliable results
            - didn't compress pads hoping reflow would occur with enough solder (did not happen due to different pad width and solder height)
            - intermittent connections which gave impression of good solder connection but failed when connected (flex pcb would bend and cause already bad connections to then obviously fail)
            - compressed connection during reflow hoping for better results which then caused very difficult to see shorts
                - required going under a magnifying glass with good lighting to see bridges at SMD pads


- performance goals
    - PCIe 3.0 achieved with stability
    - 3.37GB/s or 27Gb/s symmetrical transmit and receive
    - stable connection when stress tested with AIDA64, furmark, 3dmark pcie bandwidth test
    - flexpcb and single board design has same PCIe performance (negotiated and trained PCIe 3.0)

- performance issues or failures
    - flexpcb was hopefully meant to achieve PCIe 4.0 (very optimistic)
        - dielectric loss of flex pcb substrate (polyethylene) might be alot lower than FR4 (0.1?)
        - fibreglass dielectrics have higher losses
        - pure plastic dielectrics might have lower losses???
        - issue is that this is not well specified by manufacturer so it is difficult to determine if this is true
        - goal with flex pcb design was that by using a majority flexpcb design with a low loss dielectric, there would be less signal loss
    - single board design had transmission lines that had 2 via jumps which is bad for performance
    - flexpcb design has 1 via jump (might have lower signal losses)
    - flexpcb design has two additional potential transmission line discontinuities with addition of flexpcb (these might be worse or better than having an additional via)
    - geometry of taper, impedance of differential pair on flexpcb, m2 board and oculink port board must match otherwise you get discontinuities (signal reflections)
    - geometry and design of flexpcb is very important due to the hatch plane
        - in order to reach the 85ohm differential impedance the ground plane cannot be solid
        - hatched ground plane must have gaps smaller than some fraction of the upper frequency, otherwise it will radiate energy
        - thin 0.1mm trace from simulation results meant that skin effect was extremely important
            - without a very flat polished copper finish a 0.1mm trace would have very high impedance
            - probable the dominant factor in not being able to reach PCIe 4.0 speeds
    - no impedance calculators for hatched ground planes so needed to use openEMS for impedance measurement

- openEMS experience
    - openEMS is a C++ cpu based FTDT simulation tool
    - python wrapper I used leverages the python library for openEMS and converts gerber files for simulation
    - issue is that simulation results and online calculator results differ
        - unclear if I can use results reliably
    - need high resolution to avoid artifacts
    - issues with script misplacing ports resulting in bad simulations
        - needed to rewrite scripts to function correctly
        - had to do with port position outputted by kicad and cropping of gerber image file resulting in misalignment
    - needed paraview to visually confirm that simulation was occuring correctly
        - needed to learn how paraview worked correctly (rescale to fit data so you can see EM waves)
        - useful for identifying bad port placement (bad position or bad orientation)
        - very important debugging tool to confirm simulation occured correctly
    - script simulates metal layers as infinitely flat planes
        - problematic with flexpcb where the metal layer and substrate thickness are very similar
- ansys simulator very difficult to import gerber design from kicad
    - difficult to setup and results dont make sense
    - simulation often fails for unclear reasons, error dialogue and messages not useful
    - no clear way to have a 2d visualisation like openEMS + paraview for verification (might be possible but I gave up)
    - attempted because it supports GPU acceleration which improves simulation speed, but only for NVIDIA gpus via CUDA which is not useful for my AMD gpu

- via fence design
    - JLCPCB doesn't support blind or buried vias
    - read that having a staggered via fence might produce better results (need to find source for this???)
    - needed to redo via fence with through hole vias (which jlcpcb supports)
    - single board and flex pcb design both utilise via fences to create ground shielding

- vias in transmission line
    - unclear how to model impedance of via discontinuity
    - openEMS results seem very mixed
    - online sources talk about simulating signal via with surround ground via
        - calculators which are unavailable unless you pay for very expensive simulation tools
        - calculators which only work with singled ended connections not differential
    - eventually due to cost reasons had to use a single drill bit size to meet minimum via size requirements for jlcpcb
        - lower via size was much much more expensive
        - larger via size meant I could get cheapest price from JLCPCB
        - meant than only free parameter I had for signal via design was distance and number of ground vias to surround the signal via
    - designing the via connection geometry to trace is a concern
        - annular ring size determine impedance
        - teardrop or taper to via also affect impedance discontinuity
    - the tx lines in flexpcb design had no via but the rx lines had vias to reach other side of oculink connector pads
        - this might have meant tx lines were capable of pcie4.0 but the rx lines were only capable of pcie 3.0, resulting in the link downgrading
        - difficult to test this without high frequency signal generator and oscilloscope 
            - pcie 4.0 has a fundemental frequency of 8GHz, with 5th harmonic being 40GHz for good eye opening
            - possible to test basic parameters like insertion loss at lower frequencies (10MHz is the highest I can go on my own cheap signal generator with 100MHz oscilloscope), but since it negotiates a PCIe 3.0 signal this means that problems don't occur until higher frequencies which we can't test for

- via stubs and back drilling
    - in single board design signal traces were located on layer 1 and layer 3
        - layer 2 and 4 were ground planes
        - via fence connecting coplanar ground in layer 1 and 3 to ground planes hopefully resulted in excellent shielding
        - problem is that signal vias connecting signals traces from layer 1 to 3 would have a stub extending from layer 3 to 4
        - ideally you are meant to back drill these vias and avoid having the stub
        - stubs at RF frequencies result in reflections and non uniform impedance across a frequency range
        - adds additional cost and not all fabs support this (jlcpcb included)
    - in successive flexpcb design placement of flex pcb was chosen to reduce number of vias
        - when vias were used they connected signal planes from layer 1 to 4, meaning that there would be no stubs
        - might have improved RF performance but difficult to test without proper equipment

