{"/oculink_m2_adapter/docs/":{"data":{"":" Specifications Design Manufacturing Results Conclusion "},"title":"Documentation"},"/oculink_m2_adapter/docs/conclusion/":{"data":{"":"","aliexpress-adapter#Aliexpress adapter":" Otherwise purchasing a PCIe 4.0 adapter from aliexpress with bendable cables is a better option More performance Cheaper overall when considering parts and equipment Sourcing oculink port and SMD components has a hefty shipping fee from most electronic suppliers Aliexpress has very low to non existent shipping fees Adapter has controlled impedance cables in many lengths which are bendable and thus can be adapted to a variety of enclosures ","custom-adapter#Custom adapter":" Can be designed and achieve PCIe 3.0 speeds reliably Unlikely to achieve PCIe 4.0 due to aformentioned issues Time consuming to construct Difficult to manufacture requiring multiple attempts Potential risk of shorting if assembly was done poorly If form factor is extremely unusual or limited this might be an option you should consider ","future-plans#Future plans":" In flex pcb design the oculink port board can be swapped out with another type of connector Potential candidates are Mini cool edge IO (MCIO) - Better official number of insertion cycles Far far future there may be electrical to optical solution for PCIe like with PCIe 7.0 (unlikely to be available at consumer prices) Improved oculink connector that is rated for higher insertion cycles Wait for Thunderbolt 5 with 128Gbp/s of bandwidth Thunderbolt 4 with 64Gbp/s of bandwidth should be comparable to PCIe 4.0 x 4 but there is overhead somewhere which results in much worse performance Requires a very recent CPU to have support for Thunderbolt 4 Thunderbolt eGPU docks are very expensive Oculink solution has cheaper cables and eGPU docks compared to thunderbolt 3 and 4 solutions USB 4 64Gbp/s has similar overhead problems to thunderbolt ","lessons-learnt#Lessons learnt":" Interesting exercise in practical high frequency transmission line design Research was relatively straight forward due to public schematics from AdtLink and datasheets Design was time consuming especially for the flex pcb which required a manually routed hatched ground plane due to KiCAD limitations Altium or more mature software might have better hatched ground plane design tools In order to route bends in hatched ground plane it was easier to make the entire hatch manually with trace segments Distort the hatch at bend to maintain as much symmetry Using default hatched ground plane implementation would have resulted in extreme inter-pair skew and terrible performance Manufacturing was time consuming due to microsoldering, improper reflow, and hand testing of adapter Unless stencil application is ideal there will be dry joints or bridges Difficult or impossible to visually inspect since half of the oculink pads are underneath the port Due to use of passive components, the most informative part of this project was high frequency transmission line design PCIe redriver ICs are not cheap and are not usually sold in low quantities Optimised passive adapter is the most cost effective option Microsoldering of flex pcb could achieve near zero pitch error with aid of magnifying glass but is limited to dexterity and patience Aliexpress adapter uses special micro coaxial cables which will perform better than flex pcb with hatched ground plane or direct routing over lossy FR4 over distances longer than 10cm Design of hatch ground plane is not solvable using equations Requires simulation tools openEMS is a free option but is uses the CPU only and only leverages SSE extensions which are a decade old Open source github repo that handles preprocessing of gerber files, setup of openEMS simulation, and analysis of results to produce impedance graphs over frequency Ansys does not have a easy (or at least not something that is easy to look up) way of importing gerber files for simulation Ansys is GPU accelerated but only with CUDA, which is okay if you have an Nvidia gpu but not if you have an Intel or AMD gpu Ansys will sometimes give an error without an explanation ","requirements-to-reach-pcie-40#Requirements to reach PCIe 4.0":" Final performance of adapter reached minimum target of PCIe 3.0 but failed the more ambitious PCIe 4.0 To reach PCIe 4.0 it would probably require:\nLower loss dielectric materials Better simulation of via jumps in transmission line to match impedance and prevent reflections Better design of flex pcb hatched ground plane to hit impedance target or avoid it altogether with single board design Increase transmission line trace width to mitigate impact of skin effect at higher frequencies (most effective) Use thicker copper layers (only effective at lower frequencies) Use smoother copper finish since surface roughness results in higher impedance due to skin effect (very effective) Unknown if this can be done cheaply without moving to a more expensive HDI stackup Replace flex pcb with micro coax (doesn’t seem easy to do since it would require alot of microsoldering of extremely fine traces) "},"title":"Conclusion"},"/oculink_m2_adapter/docs/design/":{"data":{"":" Reference designs Laptop measurements KiCAD \u0026 JLCPCB Single board design Flex connector design Transmission line OpenEMS "},"title":"Design"},"/oculink_m2_adapter/docs/design/flex_pcb/":{"data":{"":"","advantages#Advantages":"Benefits of vertical routing Vertical routing under M.2 2280 slot has a much wider room. Removes requirement to move high frequency PCIe signal traces onto a different layer. Avoiding additional via jumps which results in better signal integrity. PCIe lanes for both RX and TX have 1 via jump. This is an improvement for TX lanes over the single board design which have 2 via jumps. Allows adjustment of height offset of Oculink port for ideal positioning against side of laptop chassis. Benefits of flexible PCB connection Flex PCB is designed to bend unlike a fibre glass core which prevents possible damage.\nOculink port is on separate board which doesn’t have to bend avoiding any possible mechanical damage to the SMD pad connections. Allows for more flexible positioning of the Oculink port if there is some error in the measurements. Polyimide dielectric Flex PCB uses a polyimide core which potentially could have a low dielectric loss.\nOverall length of PCIe lanes is the same but majority is over the lower dielectric loss polyimide. Could improve signal integrity however this is difficult to verify without proper equipment. Flexibility of design Easier redesign if future changes need to be made.\nM.2 card board can be kept constant. Flex connector can be easily redesigned and cheaply made. Port board can be swapped if Oculink port is damaged. Port board can be re-engineered to use a different PCIe compatible port like MCIO. Lower manufacturing cost. Cheaper overall manufacturing compared to single board design (using JLCPCB).\nM.2 card is only 22mm x 42mm which is under 50mm x 50mm threshold resulting in $2.00USD board cost. M.2 card is 0.8mm which means mandatory lead free HASL that costs $4.80USD. Oculink port board is only 21mm x 87mm which is under the 100mm x 100mm threshold meaning no additional engineering fee. Oculink port board exceed 50mm x 50mm threshold which means board cost of $7.00USD. Oculink port board can be manufactured on a stackup thicker than 0.8mm enabling HASL with lead which is free. Flexible PCB connector can be manufactured at $2.00USD. Overall cost of $15.80USD. ","disadvantages#Disadvantages":"Variability in polyimide properties Flex PCB polyimide material comes in several varieties.\nNo guarantee that the polyimide used is a low dielectric loss formulation. JLCPCB datasheet for their polyimide supplier shows a dielectric loss which is still substantial. Due to thinner stackup the electric field strength is significantly higher over a thicker stackup on FR4. This high E-field magnitude can result in even greater dielectric losses. If this isn’t offset by a low loss polyimide dielectric then the flex pcb may perform much worse than routing on FR4. Transitioning transmission line geometry Flex pcb requires handling transition of transmission line from FR4 stackup to flex PCB stackup.\nRequires careful design to avoid impedance discontinuities at flex PCB connection. Involves designing transmission line tapers to maintain impedance target across connector transition. Transmission line design Transmission line design on flex pcb Flex pcb has a very thin dielectric core for easy bending.\nThin dielectric means transmission line needs to be designed with extremely thin traces. Calculations with a solid ground plane puts trace width at \u003c 0.05mm which is not manufacturable. Requires using a hatched ground plane to achieve target impedance at manufacturable 0.1mm trace width. Hatched ground plane needs very careful design considerations and is not trivial to design. Hatched ground plane design Design and manufacturing complexity Additional complexity due to multiple boards.\nMore difficult manufacturing and electrical testing due to additional soldering steps for flex connector. More difficult design since KiCAD doesn’t support multi-board designs necessitating multiple projects. Requires a more complicated project layout to support sharing of common resources like the flex connector footprint. Requires careful design to make sure design changes are reflected across all 3 board designs (M.2 card, flex connector, Oculink port board) to avoid miswiring. Potential EMI issues Use of hatched ground plane instead of solid ground plane in flexible connector results in worse shielding at higher frequencies determined by hatch gap size. Since flexible pcb is routed underneath a PCIe 4.0 x 4 SSD in the M.2 2280 slot it could mean the Oculink connection will interfere with the SSD. Not that likely interference will be significant since the SSD also has it’s own internal solid ground plane which should shield EMI between SSD and Oculink connection. Potential safety issue Flexible PCB is routed over the battery pack. In the event of a short in the Oculink connection the battery pack could be damaged and possibly ignite. Not that likely since PCIe connection carries low power signals and 3.3V rail isn’t used to deliver any signficant amount of power to the eGPU dock. ","images#Images":" Image 13. Custom M.2 to Oculink adapter with flex connector PCBs Image 14. Custom M.2 to Oculink adapter with flex connector 3D renders "},"title":"Flex connector design"},"/oculink_m2_adapter/docs/design/kicad_jlcpcb/":{"data":{"":"","generating-gerber-and-drill-files#Generating gerber and drill files":" Gerber and drill files must match what the fabricator expects. JLCPCB specifies instructions for KiCAD 7.0 as well as other versions. JLCPCB instructions to generate KiCAD 7 gerber and drill files (source) Verify output through local gerber viewer program before submitting. Final verification in JLCPCB online gerber viewer after uploading design. ","importing-design-constraints-into-kicad#Importing design constraints into KiCAD":" JLCPCB specifies manufacturing capabilities. JLCPCB manufacturing capabilities The values for certain constraints will vary depending on options you select for the number of layers, minimum via size and stackup type. KiCAD supports creating a design rules file to automatically check these manufacturing constraints to prevent submitting unmanufacturable designs to a fabricator. The design rules checker (DRC) can be triggered manually or is run automatically before generating gerber and drill files. Sample KiCAD design rules file ","reasons-to-use-jlcpcb#Reasons to use JLCPCB":" The cheapest PCB manufacturer. Offers plenty of discounts for extremely low prices. If you stay under certain size requirements the cost will remain exceptionally low. Inexpensive 0.8mm thick stackup which is required for M.2 edge connector. Only requires lead free HASL to be the mandatory surface finish which costs $4.80USD. Inexpensive board cost if certain size thresholds aren’t exceeded. For boards less than 50mm x 50mm board cost is only $2.00USD. For boards between 50mm x 50mm and 100mm x 100mm the board cost is $7.00USD. For boards above 100mm x 100mm there is an aditional engineering fee which costs $24.00USD. Inexpensive 4 layer boards which are important for maintaining solid ground plane if signal traces need to be routed on separate layers. Controlled impedance stackup to meet transmission line design requirements. Allows choosing denser more uniform fibre weaves to improve signal integrity in transmission lines. A non-uniform weave could cause problems if a differential trace were routed over it. Each side of the pair could be on a piece of the weave with different densities of fibres. This would mean each trace in the pair experiences a different dielectric constant. Since the speed of propagation is dependent on the dielectric constant, a skew in the time domain would be induced in the differential pair. PCIe standard has relatively ENIG (gold plating) to prevent oxidation of M.2 edge connector and flatter profile for more reliable reflow soldering. Flexible PCBs for designs that require large amounts of vertical routing. Very generous constraints minimum via sizes and pad pitch which is important for high frequency design where physical dimensions of traces, vias, and connector pitch can get very small. ","reasons-to-use-kicad#Reasons to use KiCAD":" Free and open source. No license required for usage. More than adequate for passive M.2 to Oculink adapter. Transmission line calculators are limited but there are plenty of more capable free and public options. Lacks high end simulation capabilities like Altium but open source substitutes are available. "},"title":"KiCAD \u0026 JLCPCB"},"/oculink_m2_adapter/docs/design/laptop_measurements/":{"data":{"":"","measurement-and-modelling#Measurement and modelling":" Image 8. Measurements and prototype layout for M.2 to Oculink adapter Image 9. 3D modelling of Lenovo 16arp8 based on measurements Modelling was done from a sparse set of measurements. After modelling was done arbitrary measurements of any feature could be done. Easier than measuring every possible dimension when needed. ","planning#Planning":" Longer M.2 2280 slot is used for high capacity SSD. Shorter M.2 2242 slot is available but in a less convenient location. Left speaker can be removed to make room for Oculink port. M.2 2242 slot has 1mm of clearance for bottom side passive components. Option 1: Very narrow 12mm gap between M.2 2280 connector and internal display connector for single board design for side Oculink port. Option 2: Vertical space underneath M.2 2280 slot for routing with a flex pcb design that has a side Oculink port. Option 3: Use vertical Oculink adapter and have port on bottom instead of side of laptop. Image 10. NFHK vertical M.2 to Oculink adapter card (source) "},"title":"Laptop measurements"},"/oculink_m2_adapter/docs/design/reference_designs/":{"data":{"":"","adtlink-m2-to-oculink-card#Adtlink M.2 to Oculink card":" Image 6. Adtlink F4C M.2 to Oculink adapter card (source) Image 7. Purchased Adtlink F4C M.2 to Oculink adapter card with modifications Adtlink PCIe 4.0 eGPU Oculink dock [PERST, CLKREQ] are connected. [PEWAKE, PEDET] are not connected. [SMB_CLOCK, SMB_DATA] are connected. [MFG_CLOCK, MFG_DATA] are not connected. 3.3V is connected. REFCLK is connected with same polarity. [PERxy, PETxy] lanes are connected with opposite polarity and opposite order. ","adtlink-m2-to-pcie-extension#AdtLink M.2 to PCIe extension":" Image 4. Adtlink M.2 to PCIe 4.0 adapter (source) Adtlink M.2 PCIe x4 extension cable schematic (source) [CLKREQ, PERST] are connected. [PEWAKE, PEDET] are not connected. [SMB_CLOCK, SMB_DATA] are not connected. [MFG_CLOCK, MFG_DATA] are not connected. 3.3V is connected. REFCLK is connected with same polarity. [PERxy, PETxy] lanes are connected with same polarity and same order. ","gpd-win-v1-m2-to-oculink-card#GPD Win v1 M.2 to Oculink card":" Image 5. GPD win 1 M.2 to Oculink adapter card (source) Gpdwin1 M.2 to Oculink adapter schematic (source) [PERST, PEDET] are connected. CLKREQ is connected but through a Schottky diode. PEWAKE is not connected. [SMB_CLOCK, SMB_DATA] are not connected. [MFG_CLOCK, MFG_DATA] are not connected. 3.3V is connected through a jumper. REFCLK is connected with same polarity. [PERxy, PETxy] lanes are connected with same polarity and same order. ","points-to-verify#Points to verify":" Do you wire from PERxy on the M.2 side to PERxy on the Oculink side, or PERxy to PETxy? Do all of the control signals need to be connected? Is SMB (system management bus) data and clock required or is it optional? What about the MFG (manufacturer) data and clock on the M.2 card which is not present on the Oculink connector or PCIe standard? Is lane reordering and polarity inversion okay to use for routing PCIe connections? ","summary#Summary":" PERST must be connected. CLKREQ must be connected, possibly through a diode, or shorted to ground on host side. PERST is optional. PEWAKE is not connected (might be optional?). [SMB_CLOCK, SMB_DATA] are optional. [MFG_CLOCK, MFG_DATA] are not connected. 3.3V is connected. REFCLK must be connected with same polarity. [PERxy, PETxy] can be connected in opposite polarity and/or opposite order. "},"title":"Reference designs"},"/oculink_m2_adapter/docs/design/single_board/":{"data":{"":"","advantages#Advantages":"Simpler design Easier manufacturing and testing since we only need to solder the Oculink port and passive components. Single KiCAD schematic required allowing for easier design inside single project. Requires only a single transmission line to be designed reducing design complexity. More reliable performance Having multiple boards connected over a flexible PCB adds additional potential impedance discontinuities. Without equipment to verify performance at PCIe 3.0+ frequencies it is difficult to validate performance. Introducing fewer design uncertainties will make final performance more likely to align with calculations. ","disadvantages#Disadvantages":"Narrow routing resulting in layer transition PCIe signal lanes have to fit through a very narrow region which requires routing differential pairs onto other layers.\nRequires careful design of via jumps to prevent impedance mismatch and signal reflection. PCIe RX lanes have 1 via jump and PCIe TX lanes have 2 via jumps. Each additional via jump will worsen signal integrity so having 2 is unideal. Port location and bending Board has to be slightly bent so that Oculink port is at the correct height with laptop chassis.\nMight result in damage to circuit if the board isn’t flexible enough. Could result in degraded transmission line performance due to stretching of traces and introduction of inter-pair skew in differential pairs. Could result in Oculink port pad connection breaking due to uneven mechanical stress. Long distance routing PCIe lanes have to be routed over a moderately long distance (12cm).\nWe are using FR4-TG135 which has a high dielectric loss at high frequencies. If we are targetting PCIe 4.0 then we need to handle the 5th harmonic of the fundemental frequency which is 40GHz. It is highly unlikely to maintain PCIe 4.0 over such a long distance with a high loss dielectric. Large size Single board design is relatively large.\nM.2 slot requires 0.8mm thickness which results in mandatory lead free HASL that costs $4.80USD. Exceeds 50mm x 50mm threshold meaning board goes from $2.00USD to $7.00USD. Exceeds 100mm x 100mm threshold meaning additional engineering fee of $24.00USD. Overall cost of $35.80USD. ","images#Images":" Image 11. Custom single board M.2 to Oculink adapter PCB Image 12. Custom single board M.2 to Oculink adapter 3D render "},"title":"Single board design"},"/oculink_m2_adapter/docs/design/transmission_line/":{"data":{"":" Structures Via fence Via jumps Skin effect Skew requirements Hatched ground plane Flex connection "},"title":"Transmission line"},"/oculink_m2_adapter/docs/design/transmission_line/flex_connection/":{"data":{"":"","stackup-height-differences#Stackup height differences":" Image 32. JLCPCB FR4 stackup vs flexible PCB stackup (source) Transitioning our transmission line from an FR4 stackup to a flexible PCB stackup causes the height of the dielectric in the transmission line to significantly decrease.\nTherefore signal trace to ground plane capacitance increases which causes impedance to decrease. Mismatch in impedance causes signal reflections and reduced integrity. Hatched ground plane If the transmission line signal traces have the same width, using a suitably designed hatched ground plane will increase the impedance to meet our impedance target.\nSee designing hatched ground plane for more details. ","structure-of-transmission-line#Structure of transmission line":" Image 31. Differential pair with coplanar ground plane stitched with via fence The following are useful equations to describe the impedance of the transmission line in relation to it’s geometry. These will be useful in determining which parameters to adjust if we want to meet our PCIe impedance target. This comes at the cost of lower modularity but is this is an acceptable compromise for higher guarantees of high frequency signal performance.\nCharacteristic impedance Rough equation for a simple transmission line is given by:\n\\[ Z_0 = \\sqrt{\\frac{L}{C}} \\]\nThis is still useful when discussing changes in impedance for a variety of transmission line structures if we discuss them in terms of differing trace inductances and capacitances.\nUniversity of San Diego: Waves and impedances on transmission_lines Parallel plate capacitors The capacitance between a simple two plate system is given by: \\[ C = \\frac{\\epsilon_0 A}{d} \\]\nImage 35. Parallel plate capacitor (source) Wire over plane The inductance of a wire over a plane can be approximated as: \\[ L = \\frac{\\mu_0 \\mu_r d}{2 \\pi} cosh^{-1}{\\frac{h}{2r}} \\]\nImage 34. Solid wire over ground plane (source) ","type-of-connection#Type of connection":"Flexible flat/printed cable connector Image 36. Molex FFC/FPC connector (source) Advantages Disadvantages Flexible connector can be replaced without resoldering the connector. Allows for easier installation and removal without danger of damaging flexible connector. Requires designing transmission line to gracefully transition to the connector without a large impedance discontinuity. Higher insertion loss compared to soldered connection since contact surface isn't perfect and there will be stubs from the internal connectors. This could hamper high frequency performance. Maximum usable frequency before insertion loss is more than 3dB is usually below 20GHz. This is the recommended design frequency for a good eye opening for PCIe 3.0 which has a fundemental frequency of 4GHz. Requires reflow soldering the connector which is extremely difficult for a fine pitch connector (0.2mm) without risk of bridging. Connectors add a few extra dollars of cost to the bill of materials Molex: FFC/FPC connector maximum usable frequency and compatability with high speed USB (source) Soldered connection Advantages Disadvantages Allows for more control over the design of the transmission line structure Lower insertion loss since connection is soldered. This means no stubs caused by extra internal connector pins or non-ideal/non-uniform contact surface. Connector SMD pads can be designed specifically to avoid discontinuities in impedance caused by trace length mismatch, loss of coplanar ground traces or ground plane. Low tolerance for z-height error on pad connections requires soldering the connector very flat to the SMD pads. This may require pressure during the reflow process Requires hand positioning of flexible connector onto pads which is extremely difficult since the traces are only 0.1mm. Any pitch error will result in possible bridging or degraded signal integrity Flexible pcb is not removable and is permanently connected to the boards. This might make installation or removal more difficult if connector is in a suboptimal location. Final choice The soldered connection allows closer control over the design of the tranmission line and avoids the downsides of a FFC connector. This should allow us to avoid or mitigate the signal integrity issues that will arise from the use of a FFC connector.","vertical-transmission-line-connection#Vertical transmission line connection":" Image 33. JLCPCB transmission line connection between FR4 stackup and flexible PCB Transition from FR4 stackup to flexible PCB involves a vertical solder connection which produces an impedance discontinuity.\nThe coplanar ground traces experience some discontinuity when it meets the solder connection due to an increase in the conductor height. Results in an increase in edge coupling area. This increases capacitance and decreases impedance. The E-fields between the signal traces and ground planes have to switch layers. Broadside coupling means stronger E-fields and more energy being carried compared to the coplanar ground traces which use edge coupling. Capacitive coupling is greater through a broadside connection since the traces are 0.1mm wide, compared to the edge side coupling which occurs over a 0.012mm or 0.035mm This was verified through an open EMS simulation. Tapered connection Image 37. Flexible PCB transmission line taper A taper is a gradual change in the geometry of a transmission line that attempts to maintain consistent impedance value across a geometric transition.\nWe use a linear taper to transition the E-field broadside coupling from the ground plane on the M.2 card to the ground plane on the flexible PCB. A linear taper is not necessarily the best however it is very simple to design. Altium: How to design an RF taper for impedance matching Other taper designs have complex non-linear equations describing their shape which is difficult to import/design using KiCAD. Linear taper just requires the polyline tool in KiCAD. Parametric optimisation of taper To verify the performance of the taper openEMS was used.\nSimulated stackup with flex PCB connected to FR4 transmission line as a 3 layer board. Layers were: [FR4 ground, signal traces, flex PCB ground]. The soldered signal traces were approximated as an ideal single trace on a single layer. This was done so that only the E-field transition between the ground planes was relevant for our parametric search. Might not be ideal from a simulation accuracy standpoint as the geometry of the solder connection might impact the impedance match. However representing the solder connection in our simulation setup was difficult so this approximation/assumption was used. Parametric search was done on the length and width of the linear taper. Shape of taper was modified separately on the FR4 stack up and flexible PCB stackup. Possible that simulation was not accurate since mesh size is limited and linear taper requires very small simulation grid size to accurately capture the pointy part. "},"title":"Flex connection"},"/oculink_m2_adapter/docs/design/transmission_line/hatched_ground_plane/":{"data":{"":"","additional-design-considerations#Additional design considerations":"Refer to minimising intra-pair skew for hatched ground planes and differential pairs.","determining-parameters#Determining parameters":"There are three major parameters to consider:\nTrace width. Hatch width. Hatch gap. Since we need to be above the minimum trace width for JLCPCB to manufacture it, we should select a fixed trace width of 0.1mm.\nThis is similar the trace width of 0.13mm for our transmission line on the FR4 substrate for both the M.2 cad and Oculink port board. This means we will have an easier time designing a taper geometry when connecting the flex connector to our boards (discussed here). Means we only need to perform a parametric search with two variables (the hatch width and gap) which is less time consuming. ","hatched-ground-plane#Hatched ground plane":" Hatched ground plane can allow for wider traces while matching impedance. No easy equation to get impedance measurement (fill factor approximation does not model this adequately). Design of hatched ground plane must meet manufacturing capabilities of JLCPCB. Requires parametric search with simulation software. Refer to this section about simulating circuits with openEMS. ","problems-with-thin-flexible-pcb#Problems with thin flexible PCB":" The base polyimide dielectric core has a thickness of 25um. This means that we need extremely thin traces with a solid ground plane if we want to reach our PCIe impedance target. Thicker dielectric cores are provided but they increase cost substantially and trace width barely increases. Even worse the calculated transmission line trace width is calculated as 0.05mm which is below JLCPCB’s manufacturing minimums. "},"title":"Hatched ground plane"},"/oculink_m2_adapter/docs/design/transmission_line/skew_requirements/":{"data":{"":"The PCIe standard specifies several requirements for differential pair skew.","inter-pair-skew-between-lanes#Inter-pair skew (between lanes)":"Inter-pair skew is usually not specified but has a lower bound of 1ns for PCIe 4.0.\nAssuming a propagation speed of 0.6c, the inter-pair skew is around 20cm. Since this is such a large value the inter-pair skew requirement is difficult to violate. The reason for this is because the PCIe standard states that transceivers have to do symbol synchronisation. Usually done with a buffer which usually can store around 20 symbols for each lane. For PCIe 4.0 at a transfer rate of 16GT/s, 20 symbols have a duration of 1.25ns. ","intra-pair-skew-within-lane#Intra-pair skew (within lane)":"Intra-pair skew must be less than 5 mils (0.127mm) which is rather small margin of error. The following are phenomena that can contribute to intra-pair skew and methods to mitigate them.\nBends in transmission line Image 23. Techniques to length match differential pair (source) Bending causes the lengths of differential traces to become shorter and longer resulting in skew. Can be avoided by keeping bends short so local skew error is below 5 mils. If skew error is too large than it should be immediately corrected near the bend by adding serpentine bends for the shorter side of the differential pair. KiCAD can automatically do this using their skew correction tool. Fibre weave effect Image 24. Asymmetric routing over fibre-weave can produce intra-pair skew (source) Image 25. Asymmetric routing over fibre-weave will degrade eye opening (source) Signal integrity: Beware of the skew budget with fibre weave effect Cadence: The fibre weave effect, skew, losses and resonance A poor choice of a dielectric with a non-uniform fibre weave pattern can result in large intra-pair skews. There is also no method of designing the circuit around a bad fibre weave since the manufacturer cannot position the weave at a specific offset. Better fibre weave patterns Image 26. Fibre weave patterns that are available from manufacturers (source) Image 27. Mechnically compressed fibre glass with flattened weave pattern (source) There should be careful selection of an appropriate fibre weave pattern for maximum uniformity. Additionally there is also mechanically compressed fibre glass which flattens the weave and fills in any gaps to produce a uniform weave pattern. Here is a pdf from Isola group who are a copper clad laminate and prepreg materials manufacturer. Isola group: Fibre weave patterns (source) It contains various high quality images of fibre weave patterns and their fill factor measurements. They also include treatment processes for bonding the prepreg and core to copper layers and how that effects the copper smoothness which is relevant for skin effect. JLCPCB controlled impedance stackup Image 28. JLCPCB fibre glass weave patterns for controlled impedance stackups (source) JLCPCB offers a variety of fibre weave patterns when a multilayer controlled impedance stackup is requested (this is also free). It is also possible to stack two or more fibre weaves vertically to increase overall density and improve uniformity. Hatched ground plane Image 29. Balanced and unbalanced routing of differential pair over hatched ground plane For hatched ground planes in a flexible pcb design asymmetric routing can produce large intra-pair skews. For straight transmission line routes it is trivial to route the differential pair symmetrically. However if the transmission line needs to bend then the hatched ground plane needs to warp to avoid introducing skew. This is exceptionally difficult to do with KiCAD’s built in hatched ground fill tool. Requires manual layout and distortion of hatched ground plane to accomodate bends in a differential pair. Image 30. Manually warped hatched ground plane with differential pair bend Unfortunately KiCAD’s built in skew correction tools cannot measure skew for hatched ground planes generated manually or automatically by their ground fill tool. This makes verification of the intra-lane skew extremely difficult at the design stage. "},"title":"Skew requirements"},"/oculink_m2_adapter/docs/design/transmission_line/skin_effect/":{"data":{"":" Image 22. Visualisation of skin effect on rough conductive surfaces (source) Skin effect is when the signal current is expelled to the surface of the conductor at high frequencies. With a rough copper finish, skin effect can result in higher trace impedance which can result in: Signal loss through resistive losses. Impedance mismatch and signal reflections. Evident Scientific: Copper foil surface roughness for 5G PCBs ","copper-finish#Copper finish":" PCB manufacturers have a variety of copper foil types to use if you need a smoother surface to avoid skin effect. Altium: Types of PCB copper foils for high frequency design Altium: Copper choice and efficiency for high frequency PCB design Type of copper foil Description Roughness Electrodeposited Has a rougher surface on one side of the copper foil Highest (above 1 um) Reverse treated Uses a surface treatment to reduce roughness Moderate (0.5 um to 1.5 um) Rolled-annealed Has a smoother, denser surface from a rolling process Low (0.25 to 0.5 um) Ultra-low profile Additional treatments are used to reduce roughness Lowest (comparable to rolled annealed, but can be less than 0.3 um) Unfortunately JLCPCB doesn’t allow you to select the type of copper foil. ","increasing-trace-width#Increasing trace width":" Use wider tranmission line signal traces to improve impedance and therefore signal integrity at higher frequencies. Comes at the cost of worse impedance matching at lower frequencies. Signal losses generally occur at higher frequencies (via jumps, tapered transitions, skin effect, insertion loss, dielectric loss). Therefore to achieve best performance over the entire bandwidth we should increase transmission line width to mitigate skin effect at higher frequencies. "},"title":"Skin effect"},"/oculink_m2_adapter/docs/design/transmission_line/structures/":{"data":{"":"PCIe receive and transmit lanes and reference clock are high frequency differential signals. There are many possible designs for a differential transmission line.\nImage 15. Differential pair topologies (source) ","best-design#Best design":"The following should be used for an optimal differential pair transmission line:\nSolid ground plane Coplanar guard traces Via fence Through this we should be able to reduce crosstalk, handle common mode noise, and reduce EMI emissions even with tightly packed PCIe lanes.","common-mode-noise#Common mode noise":"In theory a perfectly balanced differential pair would only need two conductors to handle the symmetrical current path however this should not be relied upon.\nCommon mode noise can arise due to power supply differences between host and device. This is especially important because we have a laptop powered by a USB C dock and an eGPU powered by a separate power supply. Without a ground plane or coplanar ground trace the return current for the common mode signal may be over a large loop area. This can pickup interference from environmental sources and harm signal integrity. Increases amount of EMI induced in signal traces within that loop area. ","crosstalk#Crosstalk":"Given our tight routing requirements our PCIe lanes would be extremely close together by only a few multiples of the trace width. This means we need to be very careful about inter-lane crosstalk.\nCan be fixed by increasing separation between lanes which is not possible given our tight space requirements. Adding a ground plane to confine the electric field generated by the differential pair (almost always helps). Adding coplanar guard traces to separate adjacent lanes and add additional E-field confinement. Sometimes can worsen crosstalk if guard trace is high impedance and functions closer to a resonant tank than a ground trace. Can be improved by turning coplanar guard traces into a via fence by stitching them to a ground plane This guarantees coplanar guard trace is low impedance. Also adds additional grounding with vias which further improves E-field confinement and prevents inter-lane crosstalk. ","resources#Resources":" Layout guidelines for PCIe Gen 4.0 (source) "},"title":"Structures"},"/oculink_m2_adapter/docs/design/transmission_line/via_fence/":{"data":{"":" Image 17. Via fence ","crosstalk#Crosstalk":" Improves impedance of coplanar ground guard trace by stitching it to a ground plane which improves E-field confinement. Additional ground vias improve E-field confinement. Both of these contribute to significantly reducing the inter-lane crosstalk. ","manufacturing-limitations#Manufacturing limitations":"JLCPCB has manufacturing constraints that limits the geometry of our via fence. The following values are chosen to minimise the manufacturing cost and therefore may not be the best values we can choose.\nParameter Type Value Via hole size Minimum 0.3mm Via hole diameter Minimum 0.4mm Via hole to different net distance Minimum 0.2mm Via hole to hole spacing Minimum 0.2mm Since we are targetting PCIe 4.0 our spacing requirement is 0.46mm and is within the manufacturing constraints. Our coplanar guard traces are placed 0.1mm away from signal traces so we only need 0.1mm of copper between the via and edge of coplanar guard trace. ","resources#Resources":" Effectiveness of PCB perimeter via fencing (source) Altium: Adding via stitching \u0026 via shielding Hackaday: RF \u0026 Via Stitching/Fencing ","spacing-requirements#Spacing requirements":" If spacing is incorrect it can result in worse crosstalk since fence can behave like a resonant tank. For a given maximum frequency which needs to be blocked, the equation is given as follows. \\[ \\begin{align} d_{spacing} \u0026= \\frac{\\lambda_{min}}{8} \\\\ d_{spacing} \u0026= \\frac{c}{8 \\sqrt{\\epsilon_r} \\times f_{max}} \\end{align} \\]\nFor the best eye opening we should set the maximum frequency as the 5th harmonic of the PCIe fundemental frequency. The following spacing values are calculated with \\( \\epsilon_r = 4.1 \\) for FR4.\nGen \\( f_{0} \\) (GHz) \\( f_{max} \\) (GHz) \\( d_{spacing} \\) (mm) 1.0 1.25 6.25 2.96 2.0 2.5 12.5 1.48 3.0 4.0 20 0.93 4.0 8.0 40 0.46 5.0 16.0 80 0.23 "},"title":"Via fence"},"/oculink_m2_adapter/docs/design/transmission_line/via_jumps/":{"data":{"":" Via jumps are necessary if a transmission line needs to switch lanes. In order to avoid signal reflections the characteristic impedance of the transmission line needs to remain constant when traversing from between layers through a via. ","buried-blind-and-through-hole-vias#Buried, blind and through hole vias":" Image 21. Buried, blind and through hole vias (source) Buried and blind vias can be used to avoid via stubs. These types of vias can be manufactured using a technique called backdrilling. However JLCPCB only supports through hole vias. ","coaxial-via#Coaxial via":" Image 18. Via jump with current path (red/blue) and E-field (yellow) If there are no nearby grounding vias then a distant current return path is used which results in a significant impedance mismatch. Instead we add nearby grounding vias to provide a current return path. This type of via structure is called a coaxial via. The following parameters are important when trying to control the impedance of a coaxial via: Distance of ground vias from signal via. Number of ground vias around the signal via. Hole size of the ground via and signal via. Dielectric material used to fill the vias. ","determining-parameters#Determining parameters":" There is no closed form equation for the impedance of a coaxial via with a teardrop taper. This means running a parametric search through a simulation to determine the optimal parameter values. Very difficult to do given the number of parameters for the coaxial via and teardrop taper which all impact performance. Refer to this section about simulating circuits with openEMS. ","resources#Resources":" Sierra Circuits: Coaxial via geometry Samtec blog: Practical strategies to mitigate return loss from via stubs Altium: Stubs and backdrilling in high speed design ","teardrop-taper#Teardrop taper":" Image 19. Via jump design with teardrop taper When a signal trace goes through a via there is an impedance discontinuity especially if the trace width and via diameter are different. Adjusting the following can reduce the impedance discontinuity: Adding a teardrop taper to match trace width to via diameter. Adjusting the via annular diameter. Adjusting the via hole size. ","via-stubs#Via stubs":" Image 20. Via stub back drilling (source) If via jump isn’t between the top and bottom layers then there will be a stub segment in the via. This will have the most signficant impact at the following frequency: \\[ f_0 = \\frac{c}{4 \\sqrt{\\epsilon_r} \\times d_{stub}} \\]\nActual performance degradation happens well before this frequency. By decreasing \\( d_{stub} \\) we can increase \\( f_0 \\) well past our maximum design frequency and avoid problems. If the via stub is sufficiently short then it will not have a noticeable impact on signal integrity below our maximum design frequency. "},"title":"Via jumps"},"/oculink_m2_adapter/docs/manufacturing/":{"data":{"":" JLCPCB Reflow soldering Electrical testing "},"title":"Manufacturing"},"/oculink_m2_adapter/docs/manufacturing/electrical_testing/":{"data":{"":"","checking-assembled-board#Checking assembled board":"Checking for shorts Oculink port after reflow can be shorted due to excess or smeared solder paste resulting in bridges between fine pitch pins Can redo reflow as many times until short is gone For flex pcb shorts can occur between fine pitch SMD pads of FFC connector Visual inspection through transparent FFC can reveal where shorts are Checking flex pcb during assembly For flex pcb bad connections can be checked partially through assembly Begin by soldering FFC to M.2 card Check for shorts and bad connections between M.2 edge connector and end of FFC cable Begin reflowing oculink port to separate PCB Check for shorts on exposed connector pads Bad connection or short will likely be located at FFC to oculink board connection Checking assembled board Connect oculink adapter to eGPU board The PCIe connector on the eGPU board can be used to check for continuity and shorts Refer to following schematic for pin out of PCIe connector Use m.2 edge connector as other side of connection Refer to pinout for m.2 connector ","checking-flex-pcb-during-assembly#Checking flex pcb during assembly":"","checking-for-shorts#Checking for shorts":""},"title":"Electrical testing"},"/oculink_m2_adapter/docs/manufacturing/jlcpcb/":{"data":{"":"","components#Components":" SMD components ordered from Mouser ","delivery#Delivery":"","order-cost#Order cost":" $$$ "},"title":"JLCPCB"},"/oculink_m2_adapter/docs/manufacturing/reflow_soldering/":{"data":{"":"","equipment#Equipment":" Reflow plate Soldering iron Magnifying glass Isopropyl alcohol ","ffc-connector-for-flex-pcb#FFC connector for flex pcb":" Need to apply pressure to connector while reflow occurs for complete contact There is not alot of tolerate for FFC connector when soldered since there is mechanical slack, it has to be as flat to the SMD pads as possible When reflowing connector place weights to apply even pressure across FFC connector ","reflow-oculink-port#Reflow oculink port":" Apply stencil for oculink connector, make sure there are no bridges Place oculink port Apply reflow ","smd-components#SMD components":" Can apply stencil Easier to solder by hand "},"title":"Reflow soldering"},"/oculink_m2_adapter/docs/results/":{"data":{"":" GPU bandwidth Synthetic benchmarks "},"title":"Results"},"/oculink_m2_adapter/docs/results/gpu_bandwidth/":{"data":{"":"","comparison-to-aliexpress-pcie-40-rated-adapter#Comparison to Aliexpress PCIe 4.0 rated adapter":" Reached PCIe 4.0 Double the bandwidth ","custom-adapter#Custom adapter":" Flex pcb and single board adapters both achieved PCIe 3.0 Both failed to reach PCIe 4.0 Both connections were stable Both connections got identical bandwidth measurements "},"title":"GPU bandwidth"},"/oculink_m2_adapter/docs/results/synthetic_benchmarks/":{"data":{"":"","custom-adapter-compared-to-aliexpress-pcie-40-rated-adapter#Custom adapter compared to Aliexpress PCIe 4.0 rated adapter":" Half the PCIe bandwidth resulted in degraded performance Usually occured on benchmarks with high FPS numbers where PCIe link would be used more Aliexpress PCIe 4.0 adapter achieved higher scores on average Performance penalty when monitor output has to go back through eGPU oculink connection and through iGPU to external display Setup was CPU -\u003e eGPU -\u003e iGPU -\u003e USB 4 dock -\u003e Monitor "},"title":"Synthetic benchmarks"},"/oculink_m2_adapter/docs/specifications/":{"data":{"":" PCIe Specification M.2 to Oculink "},"title":"Specifications"},"/oculink_m2_adapter/docs/specifications/components/":{"data":{"":"","m2-card#M.2 card":" Usually used for M.2 SSDs in laptop or desktop motherboards. Pins follow the PCIe specification for x4 lanes. Image 2. M.2 card size standards (source) Table 1. M.2 connector pinout (source) ","oculink-port#Oculink port":" Follows the SFF-9402 specification which is compatible with PCIe SFF-9402 specification (source) Female port is rated for 10000 insertion cycles. Male cable is rated at a minimum of 50. Compatible with the PCIe specification for x4 or x8 lanes. Wider x8 lane variant is not as useful since no M.2 slot as of yet supports PCIe x8 lanes. Amphenol Oculink port datasheet (source) Image 3. Amphenol oculink port (source) Table 2. Amphenol Oculink connector pinout (source) "},"title":"M.2 to Oculink"},"/oculink_m2_adapter/docs/specifications/pcie_specification/":{"data":{"":"","maximum-design-frequency#Maximum design frequency":"For a good eye opening the transmissions lines should be designed for 5x the fundemental frequency. For PCIe 4.0 the fundamental frequency is 8GHz which means an ideal maximum design frequency of 40GHz.\nImage 16. Eye diagram (source) ","pcie-generations#PCIe generations":" With differential signalling the fundemental frequency is half the transfer rate. An encoding scheme of xb/yb means X bits out for Y bits in. 8b/10b: 1 start bit, 8 data bits, 1 end bit. 128b/130b: 1 start bit, 128 data bits, 1 end bit. Gen Freq (GHz) Transfers (GT/s) Encoding Bitrate (Gb/s/lane) 1.0 1.25 2.5 8b/10b 2.0 2.0 2.5 5.0 8b/10b 4.0 3.0 4.0 8.0 128b/130b 7.88 4.0 8.0 16.0 128b/130b 15.75 5.0 16.0 32.0 128b/130b 31.51 PCIe: 8 Things You Need to Know Early ","pcie-pinout#PCIe pinout":" Differential signalling along receive (RX) and transmit (TX) lanes. Polarity of lanes can be inverted. Order of lanes can be reversed between host and device. Number of RX and TX lanes must be the same (symmetrical). Allows for more flexible routing in space constrained environment. Reference clock is provided from host for timing and synchronisation (100MHz). Polarity cannot be swapped. Supposed to be optional but is actually mandatory for almost all devices. CLKREQ is pull downed by device to request PCIe reference clock. PERST is used to reset the PCIe link. PEWAKE is used by device to signal to host to wake up (maybe for network cards?). SMBCLK and SMBDAT is the system management bus and is an I2C interface (optional?) Image 1. PCIe x4 connector pinout (source) "},"title":"PCIe Specification"},"/oculink_m2_adapter/gallery/":{"data":{"":"This is the about page."},"title":"Gallery"}}